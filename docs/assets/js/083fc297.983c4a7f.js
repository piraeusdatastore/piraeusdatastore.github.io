"use strict";(self.webpackChunkdocumentation=self.webpackChunkdocumentation||[]).push([[177],{3905:(e,t,r)=>{r.d(t,{Zo:()=>p,kt:()=>k});var a=r(7294);function n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,a)}return r}function l(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach((function(t){n(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function i(e,t){if(null==e)return{};var r,a,n=function(e,t){if(null==e)return{};var r,a,n={},o=Object.keys(e);for(a=0;a<o.length;a++)r=o[a],t.indexOf(r)>=0||(n[r]=e[r]);return n}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)r=o[a],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(n[r]=e[r])}return n}var s=a.createContext({}),c=function(e){var t=a.useContext(s),r=t;return e&&(r="function"==typeof e?e(t):l(l({},t),e)),r},p=function(e){var t=c(e.components);return a.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var r=e.components,n=e.mdxType,o=e.originalType,s=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),d=c(r),k=n,m=d["".concat(s,".").concat(k)]||d[k]||u[k]||o;return r?a.createElement(m,l(l({ref:t},p),{},{components:r})):a.createElement(m,l({ref:t},p))}));function k(e,t){var r=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var o=r.length,l=new Array(o);l[0]=d;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i.mdxType="string"==typeof e?e:n,l[1]=i;for(var c=2;c<o;c++)l[c]=r[c];return a.createElement.apply(null,l)}return a.createElement.apply(null,r)}d.displayName="MDXCreateElement"},2528:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>u,frontMatter:()=>o,metadata:()=>i,toc:()=>c});var a=r(7462),n=(r(7294),r(3905));const o={},l="Using LINSTOR's Kubernetes Backend",i={unversionedId:"k8s-backend",id:"k8s-backend",title:"Using LINSTOR's Kubernetes Backend",description:"Starting with release 1.16.0, LINSTOR can use the Kubernetes API directly",source:"@site/docs/04.k8s-backend.md",sourceDirName:".",slug:"/k8s-backend",permalink:"/docs/k8s-backend",draft:!1,editUrl:"https://github.com/piraeusdatastore/docs/04.k8s-backend.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Distributions",permalink:"/docs/distributions"},next:{title:"Security",permalink:"/docs/security"}},s={},c=[{value:"Manually creating a backup of LINSTOR internal resources",id:"manually-creating-a-backup-of-linstor-internal-resources",level:2},{value:"Restore a backup after a failed upgrade",id:"restore-a-backup-after-a-failed-upgrade",level:2},{value:"Delete the database",id:"delete-the-database",level:2}],p={toc:c};function u(e){let{components:t,...r}=e;return(0,n.kt)("wrapper",(0,a.Z)({},p,r,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("h1",{id:"using-linstors-kubernetes-backend"},"Using LINSTOR's Kubernetes Backend"),(0,n.kt)("p",null,"Starting with release 1.16.0, ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/linbit/linstor-server"},"LINSTOR")," can use the Kubernetes API directly\nto store the cluster state. The LINSTOR controller manages all required API definitions, including on upgrade."),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"},"NOTE:")," It is currently ",(0,n.kt)("strong",{parentName:"p"},"NOT")," possible to migrate from an existing cluster with Etcd backend to the Kubernetes\nbackend."),(0,n.kt)("p",null,"When using the new backend you can disable deploying ETCD. This also means that no existing PersistentVolumes are\nnecessary. Create an override file named ",(0,n.kt)("inlineCode",{parentName:"p"},"k8s-backend.yaml"),":"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},"etcd:\n  enabled: false\noperator:\n  controller:\n    dbConnectionURL: k8s\n")),(0,n.kt)("p",null,"Then apply it using:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"$ helm install piraeus-op ./charts/piraeus --values k8s-backend.yaml\n")),(0,n.kt)("p",null,"Since operator version v1.8.0, the operator will create a snapshot of all LINSTOR internal resources\nbefore changing the controller image. The backup is available as a secret named ",(0,n.kt)("inlineCode",{parentName:"p"},"linstor-backup-<hash>"),"."),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"},"Upgrades from before 1.8.0")," will skip the above backup step, so you should always do a manual backup (described\nbelow) in this case."),(0,n.kt)("p",null,"To copy the backup to your local machine, you can use the following command:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"kubectl get secret linstor-backup-<hash> -o 'go-template={{index .data \".binaryData.backup.tar.gz\" | base64decode}}' > linstor-backup.tar.gz\n")),(0,n.kt)("p",null,"In case the backup is too large to fit into a config map, the backup is instead written to the operator container.\nYou will see an error message on the ",(0,n.kt)("inlineCode",{parentName:"p"},"LinstorController")," resource, instructing you how to continue."),(0,n.kt)("p",null,"First you will want to copy the backup to a safe location outside the pod and create an empty secret to indicate\nthat the backup is safe and the operator can proceed:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"kubectl cp <piraeus-operator-pod>:/run/linstor-backups/linstor-backup-<some-hash>.tar.gz <destination-path>\nkubectl create secret linstor-backup-<same-hash>\n")),(0,n.kt)("h2",{id:"manually-creating-a-backup-of-linstor-internal-resources"},"Manually creating a backup of LINSTOR internal resources"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"Stop the current controller:",(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre"},'$ kubectl patch linstorcontroller piraeus-op-cs "{"spec":{"replicas": 0}}"\n$ kubectl rollout status --watch deployment/piraeus-op-cs-controller\n'))),(0,n.kt)("li",{parentName:"ol"},"The following command will create a file ",(0,n.kt)("inlineCode",{parentName:"li"},"crds.yaml"),", which stores the current state of all LINSTOR Custom Resource\nDefinitions:",(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre"},'$ kubectl get crds | grep -o ".*.internal.linstor.linbit.com" | xargs kubectl get crds -oyaml > crds.yaml\n'))),(0,n.kt)("li",{parentName:"ol"},"In addition to the definitions, the actual resources must be be backed up as well:",(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre"},'$ kubectl get crds | grep -o ".*.internal.linstor.linbit.com" | xargs -i{} sh -c "kubectl get {} -oyaml > {}.yaml"\n'))),(0,n.kt)("li",{parentName:"ol"},"Run the chart upgrade.")),(0,n.kt)("h2",{id:"restore-a-backup-after-a-failed-upgrade"},"Restore a backup after a failed upgrade"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"Unpack the backup",(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre"},"$ tar xvf linstor-backup.tar.gz\ncrds.yaml\n....\n"))),(0,n.kt)("li",{parentName:"ol"},"Stop the current controller:",(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre"},'$ kubectl patch linstorcontroller piraeus-op-cs "{"spec":{"replicas": 0}}"\n$ kubectl rollout status --watch deployment/piraeus-op-cs-controller\n'))),(0,n.kt)("li",{parentName:"ol"},"Delete existing resources",(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre"},'$ kubectl get crds | grep -o ".*.internal.linstor.linbit.com" | xargs --no-run-if-empty kubectl delete crds\n'))),(0,n.kt)("li",{parentName:"ol"},"Apply the old LINSTOR CRDs",(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre"},"$ kubectl apply -f crds.yaml\n"))),(0,n.kt)("li",{parentName:"ol"},"Apply the old LINSTOR resource state",(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre"},"$ kubectl apply -f *.internal.linstor.linbit.com.yaml\n"))),(0,n.kt)("li",{parentName:"ol"},"Re-apply the helm chart using the old LINSTOR version",(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre"},"$ helm upgrade piraeus-op charts/piraeus --set operator.controller.controllerImage=... --set operator.satelliteSet.satelliteImage=...\n")))),(0,n.kt)("h2",{id:"delete-the-database"},"Delete the database"),(0,n.kt)("p",null,"If you are using the ",(0,n.kt)("inlineCode",{parentName:"p"},"k8s")," database backend, you may want to remove the associated resources after removing Piraeus.\nOtherwise, you may run LINSTOR with outdated information if you decide to install it again. To create a local backup\nand then delete the database resources, run:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},'kubectl get crds | grep -o ".*.internal.linstor.linbit.com" | xargs kubectl get crds -oyaml > crds.yaml\nkubectl get crds | grep -o ".*.internal.linstor.linbit.com" | xargs -i{} sh -c "kubectl get {} -oyaml > {}.yaml"\n# Check the the resources are properly backed up now!\n# Then delete the LINSTOR database:\nkubectl get crds | grep -o ".*.internal.linstor.linbit.com" | xargs --no-run-if-empty kubectl delete crds\n')))}u.isMDXComponent=!0}}]);