<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-host-setup">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.22">
<link rel="alternate" type="application/rss+xml" href="/site/blog/rss.xml" title="Piraeus RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/site/blog/atom.xml" title="Piraeus Atom Feed"><title data-rh="true">Preparing the host for DRBD | Piraeus</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://piraeus.io/site/docs/host-setup"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Preparing the host for DRBD | Piraeus"><meta data-rh="true" name="description" content="Piraeus depends on DRBD for data replication across multiple nodes. [DRBD] is a kernel module that must be loaded on"><meta data-rh="true" property="og:description" content="Piraeus depends on DRBD for data replication across multiple nodes. [DRBD] is a kernel module that must be loaded on"><link data-rh="true" rel="icon" href="/site/img/piraeus.png"><link data-rh="true" rel="canonical" href="https://piraeus.io/site/docs/host-setup"><link data-rh="true" rel="alternate" href="https://piraeus.io/site/docs/host-setup" hreflang="en"><link data-rh="true" rel="alternate" href="https://piraeus.io/site/docs/host-setup" hreflang="x-default"><link rel="stylesheet" href="/site/assets/css/styles.969cd8a6.css">
<link rel="preload" href="/site/assets/js/runtime~main.32f8773a.js" as="script">
<link rel="preload" href="/site/assets/js/main.54d02352.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://piraeus.io" target="_blank" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/site/img/piraeus.png" alt="Piraeus Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/site/img/piraeus.png" alt="Piraeus Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Piraeus</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/site/docs/intro">Tutorial</a><a class="navbar__item navbar__link" href="/site/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/piraeusdatastore" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/site/docs/intro">Piraeus Operator Documentation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/site/docs/host-setup">Preparing the host for DRBD</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/site/docs/storage">Configuring Storage</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/site/docs/distributions">Distributions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/site/docs/k8s-backend">Using LINSTOR&#x27;s Kubernetes Backend</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/site/docs/security">Security</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/site/docs/optional-components">Optional components</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/site/docs/scheduling">Influencing Kubernetes scheduling</a></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/site/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Preparing the host for DRBD</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Preparing the host for DRBD</h1><p>Piraeus depends on DRBD for data replication across multiple nodes. <a href="https://github.com/LINBIT/drbd/" target="_blank" rel="noopener noreferrer">DRBD</a> is a kernel module that must be loaded on
every node that should access the storage. Depending on your exact host OS and set up, you can choose <strong>one</strong> from the
following options to load DRBD:</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="software-compatibility">Software compatibility<a class="hash-link" href="#software-compatibility" title="Direct link to heading">​</a></h2><p>Certain pieces of software conflict with Piraeus and either need to be configured to not interfere with Piraeus or they need
to be disabled to ensure Piraeus can function properly.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="multipathd">Multipathd<a class="hash-link" href="#multipathd" title="Direct link to heading">​</a></h3><p>If you are using <code>multipathd</code>, you will most likely need to change some configuration settings to ensure that Piraeus can function
properly as <code>multipathd</code> by default will interfere with Piraeus. <code>multipathd</code> by default opens up DRBD devices which prevents Piraeus
from working properly. To configure <code>multipathd</code>, put the following in the file <code>/etc/multipath/conf.d/drbd.conf</code>:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">blacklist {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        devnode &quot;^drbd[0-9]+&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You will most likely need to create the directory <code>/etc/multipath/conf.d/</code> if you have not made any other configuration changes to
<code>multipathd</code> before. Note that <code>multipathd</code> is enabled on Ubuntu 20.04 by default and this configuration change will need to be made
on fresh installations of Ubuntu 20.04 before Piraeus will be able to function properly.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="build-and-load-drbd-using-the-kernel-module-injection-image-preferred">Build and load DRBD using the Kernel Module Injection Image (Preferred)<a class="hash-link" href="#build-and-load-drbd-using-the-kernel-module-injection-image-preferred" title="Direct link to heading">​</a></h2><p>Every satellite container created by the operator will use an <a href="https://kubernetes.io/docs/concepts/workloads/pods/init-containers/" target="_blank" rel="noopener noreferrer">InitContainer</a> to ensure DRBD is available. This init
step can also compile and load DRBD directly. To build DRBD, the container needs access to the kernel sources. It will
look for the sources on the host under <code>/usr/src</code> and <code>/lib/modules/$(uname -r)</code>. Most distributions provide a convenient package
for the kernel source:</p><ul><li>Ubuntu: <code>apt-get install linux-headers-$(uname -r)</code></li><li>CentOS: <code>yum install kernel-devel-$(uname -r)</code></li></ul><p>Install these packages and use the injector image matching your distribution:</p><table><thead><tr><th>Distribution</th><th>Docker image</th><th>Original Dockerfile</th></tr></thead><tbody><tr><td>CentOS 7</td><td><code>quay.io/piraeusdatastore/drbd9-centos7</code></td><td><a href="https://github.com/piraeusdatastore/piraeus/blob/master/dockerfiles/drbd-driver-loader/Dockerfile.centos7" target="_blank" rel="noopener noreferrer">Dockerfile.centos7</a></td></tr><tr><td>CentOS 8</td><td><code>quay.io/piraeusdatastore/drbd9-centos8</code> (See <a href="https://github.com/piraeusdatastore/piraeus-operator/issues/137" target="_blank" rel="noopener noreferrer">#137</a> for CentOS 8 Stream)</td><td><a href="https://github.com/piraeusdatastore/piraeus/blob/master/dockerfiles/drbd-driver-loader/Dockerfile.centos8" target="_blank" rel="noopener noreferrer">Dockerfile.centos8</a></td></tr><tr><td>Ubuntu 22.04</td><td><code>quay.io/piraeusdatastore/drbd9-jammy</code></td><td><a href="https://github.com/piraeusdatastore/piraeus/blob/master/dockerfiles/drbd-driver-loader/Dockerfile.jammy" target="_blank" rel="noopener noreferrer">Dockerfile.jammy</a></td></tr><tr><td>Ubuntu 20.04</td><td><code>quay.io/piraeusdatastore/drbd9-focal</code></td><td><a href="https://github.com/piraeusdatastore/piraeus/blob/master/dockerfiles/drbd-driver-loader/Dockerfile.focal" target="_blank" rel="noopener noreferrer">Dockerfile.focal</a></td></tr><tr><td>Ubuntu 18.04</td><td><code>quay.io/piraeusdatastore/drbd9-bionic</code></td><td><a href="https://github.com/piraeusdatastore/piraeus/blob/master/dockerfiles/drbd-driver-loader/Dockerfile.bionic" target="_blank" rel="noopener noreferrer">Dockerfile.bionic</a></td></tr></tbody></table><p>You can set the image by passing <code>--set operator.satelliteSet.kernelModuleInjectionImage=&lt;image&gt;</code> to Helm.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="flatcar-container-linux">Flatcar Container Linux<a class="hash-link" href="#flatcar-container-linux" title="Direct link to heading">​</a></h3><p>Flatcar Container Linux requires building DRBD from source. Piraeus by default bind mounts <code>/usr/src</code> into the injection
container, as that is required on most distributions. This will fail on Flatcar Container Linux, as that directory
does not exist there, and can&#x27;t easily be created (<code>/usr</code> is always read-only).</p><p>For this case, you can disable mounting of <code>/usr/src</code> by passing
<code>--set operator.satelliteSet.kernelModuleInjectionAdditionalSourceDirectory=none</code> to Helm.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="injector-image-for-compiling-without-headers-on-host">Injector image for compiling without headers on host<a class="hash-link" href="#injector-image-for-compiling-without-headers-on-host" title="Direct link to heading">​</a></h3><p>Installing the kernel headers is not always feasible on the host. A prime example is Fedora CoreOS (FCOS), which uses
older versions of the mainline Fedora kernel. Often, the matching kernel-headers are no longer available to install and
manually manipulating the <code>ostree</code> is cumbersome. In this section we will show you how to build your own injector image
that automatically fetches the right kernel headers using FCOS as example.</p><p><strong>Note</strong>: While DRBD tries to stay compatible with the mainline kernel, there is no guarantee that a released version
will compile for every kernel.</p><p>For our custom injector image for FCOS we will need two files, a <code>entry-override.sh</code> script and a <code>Dockerfile</code>. We will
use <code>entry-override.sh</code> as our entrypoint in the injector image, i.e. the script that gets executed when the container
starts running. It will download the kernel headers and invoke the DRBD build process:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># download package matching the current kernel from build artifacts</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">koji download-build --rpm --arch</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">x86_64 kernel-devel-</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">uname</span><span class="token variable" style="color:#36acaa"> -r</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># unpack the kernel headers in the /opt directory. The default /usr/src directory is mounted read only at this point and cannot be used</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rpm2cpio ./kernel-devel-</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">uname</span><span class="token variable" style="color:#36acaa"> -r</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain">.rpm </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> cpio -idD /opt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># set the KDIR variable, telling DRBD to search for the headers in /opt</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">KDIR</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/opt/usr/src/kernels/</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">uname</span><span class="token variable" style="color:#36acaa"> -r</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">exec</span><span class="token plain"> /entry.sh </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$@</span><span class="token string" style="color:#e3116c">&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The <code>/entry.sh</code> script is taken from the existing injector image. It will invoke the right build steps and ensure all
kernel modules are loaded. We only influence where it searches for the kernel headers by setting the <code>KDIR</code> variable.</p><p>For our <code>Dockerfile</code>, we first pull in an existing injector image to access the DRBD source and the regular injector
image entrypoint. We base our actual injector image on Fedora 33 as the FCOS kernel (currently) also comes from that
distribution.</p><div class="language-dockerfile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-dockerfile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Pull in DRBD sources and entrypoint</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM quay.io/piraeusdatastore/drbd9-centos8:latest as SOURCE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM fedora:33</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Packages needed for the DRBD build process.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN yum install -y gcc make coccinelle koji cpio patch perl-interpreter diffutils kmod elfutils-libelf-devel \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &amp;&amp; yum clean all</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Our script from above</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY entry-override.sh /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># The DRBD sources and build script from an existing injector image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY --from=SOURCE /entry.sh /drbd.tar.gz /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENV LB_HOW=compile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Use our download script as entrypoint</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENTRYPOINT [&quot;sh&quot;, &quot;-e&quot;, &quot;/entry-override.sh&quot;]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Build the image, tag it and push it to a registry accessible to your cluster. You can start using your custom injector
image by passing <code>--set operator.satelliteSet.kernelModuleInjectionImage=&lt;your-custom-image&gt;</code> to Helm.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="install-drbd-on-the-host">Install DRBD on the host<a class="hash-link" href="#install-drbd-on-the-host" title="Direct link to heading">​</a></h2><p>Some users may prefer to install the DRBD directly on the host. While a DRBD package is available on some distributions,
they are often out of date and can&#x27;t be used for Piraeus. Instead, you should follow the <a href="https://www.linbit.com/drbd-user-guide/users-guide-9-0/#p-build-install-configure" target="_blank" rel="noopener noreferrer">link to DRBDs user guide</a> to
ensure you install a recent enough version. After that, please read the instructions below to make DRBD ready for
containerized workloads.</p><p>You have to disable DRBD&#x27;s user mode helper. This feature of the DRBD module enables running user configured commands on
changes in DRBDs state. When using it with containers, it could confuse programs that expect to know of all configured
DRBD resources, such as the default <code>drbdadm</code>. This command then reports an error, which is interpreted by DRBD to abort
the current transition. In the end, you are left with a lot of <code>StandAlone</code> resources that can&#x27;t be used.</p><p>To prevent this issue, you have to set the DRBD module parameter <code>usermode_helper</code> to <code>disabled</code>. To check the current
value, run:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># cat /sys/module/drbd/parameters/usermode_helper</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/sbin/drbdadm</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To disable the helper without reloading the module <em>AND</em> ensure it persist after reboots use:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># echo -n &quot;disabled&quot; &gt; /sys/module/drbd/parameters/usermode_helper</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># echo &quot;options drbd usermode_helper=disabled&quot; &gt; /etc/modprobe.d/drbd.conf</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Checking the current value again will reveal that the helper is now disabled</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># cat /sys/module/drbd/parameters/usermode_helper</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">disabled</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="disable-lvmetad-on-centos-7-and-ubuntu-1804">Disable Lvmetad on CentOS 7 and Ubuntu 18.04<a class="hash-link" href="#disable-lvmetad-on-centos-7-and-ubuntu-1804" title="Direct link to heading">​</a></h2><p>Reference: <a href="https://access.redhat.com/solutions/2053483" target="_blank" rel="noopener noreferrer">https://access.redhat.com/solutions/2053483</a></p><p>CentOS 7 and Ubuntu 18.04 by default use <code>lvmetad</code>,  a metadata caching daemon for LVM. The daemon improves performance of LVM commands by avoiding rescanning the disks on every execution. <code>piraeus-ns-node</code> pods run LVM commands inside a container without access to lvmetad. Since that means  <code>lvmetad</code> would get out of sync, it is recommended to disable <code>lvmetad</code> in CentOS 7 and Ubuntu 18.04 Bionic.</p><p>Note: Newer distributions no longer include with <code>lvmetad</code>, no changes necessary.</p><p>Follow below steps to disable lvmetad completely:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ systemctl stop lvm2-lvmetad.socket lvm2-lvmetad.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ systemctl disable lvm2-lvmetad.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ systemctl mask lvm2-lvmetad.socket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> -i </span><span class="token string" style="color:#e3116c">&#x27;s/use_lvmetad = 1/use_lvmetad = 0/&#x27;</span><span class="token plain"> /etc/lvm/lvm.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> /etc/lvm/lvm.conf </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> use_lvmetad</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use_lvmetad </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If the root partition already uses LVM, you also need to update the initial ram-disk:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># CentOS 7</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> -vf /boot/initramfs-</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">uname</span><span class="token variable" style="color:#36acaa"> -r</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain">.img /boot/initramfs-</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">uname</span><span class="token variable" style="color:#36acaa"> -r</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain">.img.</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">date</span><span class="token variable" style="color:#36acaa"> +%m-%d-%H%M%S</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain">.bak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ dracut -f -v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Ubuntu 18.04</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> -vf /boot/initrd.img-</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">uname</span><span class="token variable" style="color:#36acaa"> -r</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"> /boot/initd.img.</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">uname</span><span class="token variable" style="color:#36acaa"> -r</span><span class="token variable" style="color:#36acaa">)</span><span class="token builtin class-name">.</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">date</span><span class="token variable" style="color:#36acaa"> +%m-%d-%H%M%S</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain">.bak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ update-initramfs -c -k </span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">uname</span><span class="token variable" style="color:#36acaa"> -r</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">update-grub</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/piraeusdatastore/docs/01.host-setup.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/site/docs/intro"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Piraeus Operator Documentation</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/site/docs/storage"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Configuring Storage</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#software-compatibility" class="table-of-contents__link toc-highlight">Software compatibility</a><ul><li><a href="#multipathd" class="table-of-contents__link toc-highlight">Multipathd</a></li></ul></li><li><a href="#build-and-load-drbd-using-the-kernel-module-injection-image-preferred" class="table-of-contents__link toc-highlight">Build and load DRBD using the Kernel Module Injection Image (Preferred)</a><ul><li><a href="#flatcar-container-linux" class="table-of-contents__link toc-highlight">Flatcar Container Linux</a></li><li><a href="#injector-image-for-compiling-without-headers-on-host" class="table-of-contents__link toc-highlight">Injector image for compiling without headers on host</a></li></ul></li><li><a href="#install-drbd-on-the-host" class="table-of-contents__link toc-highlight">Install DRBD on the host</a></li><li><a href="#disable-lvmetad-on-centos-7-and-ubuntu-1804" class="table-of-contents__link toc-highlight">Disable Lvmetad on CentOS 7 and Ubuntu 18.04</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/site/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://twitter.com/piraeusds" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://join.slack.com/t/piraeus-datastore/shared_invite/zt-bzdam13n-OKextq_xY6iLRCMTwdm_oA" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/site/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/piraeusdatastore" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Piraeus Authors, The Linux Foundation</div></div></div></footer></div>
<script src="/site/assets/js/runtime~main.32f8773a.js"></script>
<script src="/site/assets/js/main.54d02352.js"></script>
</body>
</html>